#include <Adafruit_GFX.h>
#include <Adafruit_ST7735.h>
#include <SPI.h>
#include "image.h"

// ================== CONFIG ==================
#define TFT_CS     10
#define TFT_RST     4
#define TFT_DC      3
#define TFT_SCLK    6
#define TFT_MOSI    7
#define BUTTON_PIN  0

#define SCREEN_W 128
#define SCREEN_H 160
#define PASS_LENGTH 4
#define TIMEOUT_MS 5000
#define DEBOUNCE   60

// Light Theme Colors
#define LIGHT_BG 0xFFFF
#define SOFT_GRAY 0xE73C
#define MID_GRAY 0xBDF7
#define DARK_TEXT 0x4208
#define ACCENT_BLUE 0x3C9F
#define BRIGHT_BLUE 0x051D
#define SUCCESS_GREEN 0x07E8
#define GOLDEN_YELLOW 0xFF80
#define SHADOW_LIGHT 0xD6BA
#define BORDER_LIGHT 0xCE59

Adafruit_ST7735 tft(TFT_CS, TFT_DC, TFT_MOSI, TFT_SCLK, TFT_RST);

// ================== STATE ==================
enum State { BOOTING, LOCKED, UNLOCKING, MENU };
State currentState = BOOTING;

uint8_t passIndex = 0;
unsigned long lastPressTime = 0;
bool lastButton = HIGH;

// Particle structure for effects
struct Particle {
  float x, y;
  float vx, vy;
  uint16_t color;
  uint8_t life;
};

// ======================================================
// FUNCTION DECLARATIONS
// ======================================================
void drawPartialUnlockEnhancedSmall(int x, int y, int liftAmount);
void drawSuccessBurstSmall(int x, int y);
void drawSmallUnlockedLock(int x, int y);
void drawGlowingUnlockedText(int x, int y);
void drawLightMainMenuAtOffset(int xOffset, int yOffset);
void fastTransitionToMenu();
void animateSpectacularUnlock();

// ======================================================
// SETUP
// ======================================================
void setup() {
  SPI.begin();
  SPI.setFrequency(80000000);
  pinMode(BUTTON_PIN, INPUT_PULLUP);

  tft.initR(INITR_BLACKTAB);
  tft.setRotation(0);

  showBootLogo();
  delay(800);

  drawLockScreen(); 
  currentState = LOCKED;
}

// ======================================================
// MAIN LOOP
// ======================================================
void loop() {
  handleButton();

  if (currentState == LOCKED && millis() - lastPressTime > TIMEOUT_MS && passIndex > 0) {
    passIndex = 0;
    quickRedrawCircles();
  }
}

// ======================================================
// BOOT LOGO
// ======================================================
void showBootLogo() {
  tft.startWrite();
  tft.setAddrWindow(0, 0, SCREEN_W, SCREEN_H);
  for (int i = 0; i < SCREEN_W * SCREEN_H; i++) {
    tft.pushColor(unnamed_1_1_[i]);
  }
  tft.endWrite();
}

// ======================================================
// RGB565 HELPER
// ======================================================
uint16_t RGB565(uint8_t r, uint8_t g, uint8_t b) {
  return ((r & 0xF8) << 8) | ((g & 0xFC) << 3) | (b >> 3);
}

// ======================================================
// LIGHT THEME LOCK SCREEN
// ======================================================
void drawLockScreen() {
  for (int y = 0; y < SCREEN_H; y++) {
    uint8_t brightness = map(y, 0, SCREEN_H, 245, 255);
    tft.drawFastHLine(0, y, SCREEN_W, RGB565(brightness - 5, brightness - 2, brightness));
  }

  drawLockIcon(64, 45, false);
  drawLightLockedIndicator();
  drawLightPasscodeArea();
}

// ======================================================
// SIMPLE LOCK ICON (ANIMATABLE)
// ======================================================
void drawLockIcon(int x, int y, bool unlocked) {
  tft.fillRect(x - 20, y - 20, 40, 40, LIGHT_BG);
  
  if (unlocked) {
    for (int i = 2; i > 0; i--) {
      uint8_t alpha = 80 - (i * 20);
      tft.drawRoundRect(x - 10 - i, y - 4 - i, 20 + i*2, 24 + i*2, 4, RGB565(50 + alpha, 200 + alpha/2, 100 + alpha));
    }
  }
  
  tft.fillRoundRect(x - 9, y - 3, 18, 24, 4, RGB565(210, 220, 230));
  tft.fillRoundRect(x - 8, y - 2, 16, 22, 3, RGB565(230, 240, 245));
  tft.drawRoundRect(x - 8, y - 2, 16, 22, 3, unlocked ? SUCCESS_GREEN : DARK_TEXT);
  
  for (int i = 0; i < 10; i++) {
    uint8_t shade = 230 + i * 2;
    tft.drawFastHLine(x - 7, y + i, 14, RGB565(shade, shade + 5, shade + 8));
  }
  
  if (unlocked) {
    tft.fillCircle(x, y + 8, 3, RGB565(100, 255, 150));
    tft.fillCircle(x, y + 8, 2, RGB565(200, 255, 220));
  } else {
    tft.fillCircle(x, y + 8, 3, ACCENT_BLUE);
    tft.fillCircle(x, y + 8, 2, BRIGHT_BLUE);
  }
  tft.fillRect(x - 1, y + 9, 2, 6, unlocked ? RGB565(100, 255, 150) : ACCENT_BLUE);
  
  if (!unlocked) {
    for (int thick = 0; thick < 2; thick++) {
      tft.drawCircle(x, y - 10, 8 - thick, RGB565(160, 170, 190));
    }
    tft.drawFastVLine(x - 8, y - 10, 10, RGB565(140, 150, 170));
    tft.drawFastVLine(x + 8, y - 10, 10, RGB565(140, 150, 170));
    tft.fillRect(x - 8, y - 2, 2, 2, RGB565(200, 210, 220));
    tft.fillRect(x + 7, y - 2, 2, 2, RGB565(200, 210, 220));
  } else {
    int uY = y - 20;
    
    for (int g = 3; g > 0; g--) {
      uint8_t alpha = 60 - (g * 15);
      tft.drawCircle(x, uY, 8 + g, RGB565(100 + alpha, 220 + alpha/2, 150 + alpha));
    }
    
    for (int thick = 0; thick < 2; thick++) {
      tft.drawCircle(x, uY, 8 - thick, SUCCESS_GREEN);
    }
    tft.drawFastVLine(x - 8, uY, 8, SUCCESS_GREEN);
    tft.drawFastVLine(x + 8, uY, 8, SUCCESS_GREEN);
    
    tft.drawPixel(x - 5, uY - 6, RGB565(200, 255, 220));
    tft.drawPixel(x + 5, uY - 6, RGB565(200, 255, 220));
  }
}

// ======================================================
// ENHANCED PARTIAL UNLOCK - SMALL VERSION
// ======================================================
void drawPartialUnlockEnhancedSmall(int x, int y, int liftAmount) {
  uint8_t glowIntensity = map(liftAmount, 0, 10, 0, 100);
  
  if (glowIntensity > 30) {
    tft.drawRoundRect(x - 7, y - 2, 14, 18, 3, RGB565(100 + glowIntensity, 200 + glowIntensity/2, 150 + glowIntensity));
  }
  
  tft.fillRoundRect(x - 6, y - 1, 12, 16, 2, RGB565(230, 240, 245));
  tft.drawRoundRect(x - 6, y - 1, 12, 16, 2, RGB565(100 - glowIntensity/2, 150 + glowIntensity, 100));
  
  uint16_t keyholeColor = RGB565(60 + glowIntensity * 2, 150 + glowIntensity, 255 - glowIntensity * 2);
  tft.fillCircle(x, y + 6, 1, keyholeColor);
  
  int uY = y - 8 - liftAmount;
  uint16_t uColor = RGB565(100 + glowIntensity, 180 + glowIntensity, 100 + glowIntensity);
  
  if (liftAmount > 3) {
    for (int g = 2; g > 0; g--) {
      tft.drawCircle(x, uY, 6 + g, RGB565(120 + glowIntensity, 200 + glowIntensity/2, 140 + glowIntensity));
    }
  }
  
  tft.drawCircle(x, uY, 6, uColor);
  tft.drawCircle(x, uY, 5, RGB565(150 + glowIntensity/2, 190 + glowIntensity/2, 150 + glowIntensity/2));
  
  int connectionHeight = 8 - liftAmount;
  if (connectionHeight > 0) {
    tft.drawFastVLine(x - 6, uY + 3, connectionHeight, uColor);
    tft.drawFastVLine(x + 6, uY + 3, connectionHeight, uColor);
  } else {
    tft.drawPixel(x - 6, y - 1, GOLDEN_YELLOW);
    tft.drawPixel(x + 6, y - 1, GOLDEN_YELLOW);
  }
}

// ======================================================
// SMALL SUCCESS BURST EFFECT (FASTER)
// ======================================================
void drawSuccessBurstSmall(int x, int y) {
  Particle particles[10];
  
  for (int i = 0; i < 10; i++) {
    float angle = (i * 36) * PI / 180.0;
    particles[i].x = x;
    particles[i].y = y;
    particles[i].vx = cos(angle) * 2.5;
    particles[i].vy = sin(angle) * 2.5;
    particles[i].color = (i % 2 == 0) ? SUCCESS_GREEN : RGB565(200, 255, 220);
    particles[i].life = 5;
  }
  
  for (int frame = 0; frame < 5; frame++) {
    for (int i = 0; i < 10; i++) {
      if (particles[i].life > 0) {
        tft.fillCircle((int)particles[i].x, (int)particles[i].y, 1, LIGHT_BG);
        
        particles[i].x += particles[i].vx;
        particles[i].y += particles[i].vy;
        particles[i].vx *= 0.85;
        particles[i].vy *= 0.85;
        particles[i].life--;
        
        if (particles[i].life > 2) {
          tft.fillCircle((int)particles[i].x, (int)particles[i].y, 1, particles[i].color);
        } else {
          tft.drawPixel((int)particles[i].x, (int)particles[i].y, particles[i].color);
        }
      }
    }
    delay(10);  // Reduced from 12ms to 10ms
  }
}

// ======================================================
// DRAW SMALL UNLOCKED LOCK
// ======================================================
void drawSmallUnlockedLock(int x, int y) {
  for (int i = 2; i > 0; i--) {
    uint8_t alpha = 60 - (i * 15);
    tft.drawRoundRect(x - 7 - i, y - 2 - i, 14 + i*2, 18 + i*2, 3, RGB565(50 + alpha, 200 + alpha/2, 100 + alpha));
  }
  
  tft.fillRoundRect(x - 6, y - 1, 12, 16, 2, RGB565(230, 240, 245));
  tft.drawRoundRect(x - 6, y - 1, 12, 16, 2, SUCCESS_GREEN);
  
  for (int i = 0; i < 8; i++) {
    uint8_t shade = 230 + i * 2;
    tft.drawFastHLine(x - 5, y + i, 10, RGB565(shade, shade + 5, shade + 8));
  }
  
  tft.fillCircle(x, y + 6, 2, RGB565(100, 255, 150));
  tft.fillCircle(x, y + 6, 1, RGB565(200, 255, 220));
  tft.fillRect(x - 1, y + 7, 2, 4, RGB565(100, 255, 150));
  
  int uY = y - 16;
  
  for (int g = 2; g > 0; g--) {
    uint8_t alpha = 50 - (g * 12);
    tft.drawCircle(x, uY, 6 + g, RGB565(100 + alpha, 220 + alpha/2, 150 + alpha));
  }
  
  tft.drawCircle(x, uY, 6, SUCCESS_GREEN);
  tft.drawCircle(x, uY, 5, SUCCESS_GREEN);
  tft.drawFastVLine(x - 6, uY, 6, SUCCESS_GREEN);
  tft.drawFastVLine(x + 6, uY, 6, SUCCESS_GREEN);
  
  tft.drawPixel(x - 4, uY - 4, RGB565(200, 255, 220));
  tft.drawPixel(x + 4, uY - 4, RGB565(200, 255, 220));
}

// ======================================================
// DRAW GLOWING "UNLOCKED" TEXT
// ======================================================
void drawGlowingUnlockedText(int x, int y) {
  tft.setTextSize(1);
  
  char text[] = "UNLOCKED";
  int16_t x1, y1;
  uint16_t w, h;
  tft.getTextBounds(text, 0, 0, &x1, &y1, &w, &h);
  int textX = x - w/2;
  
  for (int glow = 3; glow > 0; glow--) {
    uint16_t glowColor = RGB565(80 + glow * 15, 180 + glow * 20, 120 + glow * 15);
    
    tft.setTextColor(glowColor);
    tft.setCursor(textX - glow, y - glow);
    tft.print(text);
    tft.setCursor(textX + glow, y - glow);
    tft.print(text);
    tft.setCursor(textX - glow, y + glow);
    tft.print(text);
    tft.setCursor(textX + glow, y + glow);
    tft.print(text);
  }
  
  tft.setTextColor(SUCCESS_GREEN);
  tft.setCursor(textX, y);
  tft.print(text);
  
  tft.setTextColor(RGB565(200, 255, 220));
  tft.setCursor(textX, y - 1);
  tft.print(text);
}

// ======================================================
// SPECTACULAR UNLOCK ANIMATION (FASTER)
// ======================================================
void animateSpectacularUnlock() {
  int centerX = 64;
  int centerY = 45;
  
  for (int shake = 0; shake < 2; shake++) {
    int offset = (shake % 2 == 0) ? 2 : -2;
    tft.fillRect(centerX - 20, centerY - 20, 40, 40, LIGHT_BG);
    
    tft.fillRoundRect(centerX + offset - 6, centerY - 1, 12, 16, 2, RGB565(230, 240, 245));
    tft.drawRoundRect(centerX + offset - 6, centerY - 1, 12, 16, 2, DARK_TEXT);
    tft.fillCircle(centerX + offset, centerY + 6, 1, GOLDEN_YELLOW);
    
    delay(20);
  }
  
  for (int size = 0; size < 3; size++) {
    tft.drawCircle(centerX, centerY, 12 + size * 6, RGB565(100, 200 - size * 30, 255 - size * 40));
    delay(12);
  }
  
  for (int lift = 0; lift <= 10; lift += 3) {
    tft.fillRect(centerX - 20, centerY - 30, 40, 50, LIGHT_BG);
    
    if (lift > 0) {
      int prevLift = lift - 3;
      int prevUY = centerY - 8 - prevLift;
      uint16_t trailColor = RGB565(150 + prevLift * 5, 200 + prevLift * 3, 180 + prevLift * 4);
      tft.drawCircle(centerX, prevUY, 6, trailColor);
    }
    
    drawPartialUnlockEnhancedSmall(centerX, centerY, lift);
    delay(15);
  }
  
  drawSuccessBurstSmall(centerX, centerY);
  
  tft.fillRect(centerX - 35, centerY - 35, 70, 70, LIGHT_BG);
  drawSmallUnlockedLock(centerX, centerY);
  drawGlowingUnlockedText(centerX, centerY + 25);
  
  delay(100);  // Reduced from 150ms to 100ms
}

// ======================================================
// CASCADING SLIDE TRANSITION TO MENU (0.2 SECONDS)
// ======================================================
void fastTransitionToMenu() {
  // Clear screen and draw static header
  tft.fillScreen(LIGHT_BG);
  
  // Draw MENU title (static)
  tft.setTextSize(3);
  tft.setTextColor(DARK_TEXT);
  tft.setCursor(40, 15);
  tft.print("MENU");
  
  // Draw divider line
  tft.drawFastHLine(20, 38, 88, BORDER_LIGHT);
  
  // Cascading slide animation for each menu item
  // Each item slides in one after another with slight delay
  
  // Item 1: "Settings" (selected) - slides first
  for (int slide = SCREEN_W; slide >= 0; slide -= 32) {
    // Clear previous position
    tft.fillRect(0, 50, SCREEN_W, 26, LIGHT_BG);
    
    // Draw sliding item
    if (8 + slide >= 0 && 8 + slide < SCREEN_W) {
      int rectX = max(0, 8 + slide);
      int rectW = min(120 + slide, SCREEN_W) - rectX;
      if (rectW > 0) {
        tft.fillRoundRect(rectX, 50, rectW, 26, 8, ACCENT_BLUE);
      }
      
      if (20 + slide >= 0 && 20 + slide < SCREEN_W) {
        tft.setTextSize(2);
        tft.setTextColor(ST77XX_WHITE);
        tft.setCursor(20 + slide, 56);
        tft.print("Settings");
      }
    }
    delay(2);
  }
  
  delay(15);
  
  // Item 2: "Status" - slides second
  for (int slide = SCREEN_W; slide >= 0; slide -= 32) {
    // Clear previous position
    tft.fillRect(0, 88, SCREEN_W, 20, LIGHT_BG);
    
    if (20 + slide >= 0 && 20 + slide < SCREEN_W) {
      tft.setTextSize(2);
      tft.setTextColor(DARK_TEXT);
      tft.setCursor(20 + slide, 88);
      tft.print("Status");
    }
    delay(2);
  }
  
  delay(15);
  
  // Item 3: "About" - slides third
  for (int slide = SCREEN_W; slide >= 0; slide -= 32) {
    // Clear previous position
    tft.fillRect(0, 118, SCREEN_W, 20, LIGHT_BG);
    
    if (20 + slide >= 0 && 20 + slide < SCREEN_W) {
      tft.setTextSize(2);
      tft.setTextColor(DARK_TEXT);
      tft.setCursor(20 + slide, 118);
      tft.print("About");
    }
    delay(2);
  }
  
  delay(15);
  
  // Item 4: Footer hint - slides last
  for (int slide = SCREEN_W; slide >= 0; slide -= 32) {
    // Clear previous position
    tft.fillRect(0, 148, SCREEN_W, 12, LIGHT_BG);
    
    if (30 + slide >= 0 && 30 + slide < SCREEN_W) {
      tft.setTextSize(1);
      tft.setTextColor(MID_GRAY);
      tft.setCursor(30 + slide, 148);
      tft.print("Tap to select");
    }
    delay(2);
  }
  
  // Final clean render
  tft.fillScreen(LIGHT_BG);
  drawLightMainMenuAtOffset(0, 0);
}

// ======================================================
// LIGHT LOCKED INDICATOR
// ======================================================
void drawLightLockedIndicator() {
  tft.setTextSize(2);
  char text[] = "LOCKED";
  int16_t x1, y1;
  uint16_t w, h;
  tft.getTextBounds(text, 0, 0, &x1, &y1, &w, &h);
  int textX = (SCREEN_W - w) / 2;
  int textY = 85;
  
  tft.fillRoundRect(textX - 12, textY - 6, w + 24, h + 12, 10, RGB565(240, 245, 250));
  tft.drawRoundRect(textX - 12, textY - 6, w + 24, h + 12, 10, BORDER_LIGHT);
  
  tft.setTextColor(RGB565(200, 205, 210));
  tft.setCursor(textX + 1, textY + 1);
  tft.print(text);
  
  tft.setTextColor(DARK_TEXT);
  tft.setCursor(textX, textY);
  tft.print(text);
  
  tft.fillCircle(textX - 6, textY + h/2, 2, ACCENT_BLUE);
  tft.fillCircle(textX + w + 6, textY + h/2, 2, ACCENT_BLUE);
}

// ======================================================
// LIGHT PASSCODE AREA
// ======================================================
void drawLightPasscodeArea() {
  int containerWidth = 110;
  int containerHeight = 50;
  int containerX = (SCREEN_W - containerWidth) / 2;
  int containerY = 110;
  
  tft.fillRoundRect(containerX + 2, containerY + 2, containerWidth, containerHeight, 12, SHADOW_LIGHT);
  
  for (int i = 0; i < containerHeight; i++) {
    uint8_t brightness = 248 - (i / 10);
    tft.drawFastHLine(containerX, containerY + i, containerWidth, RGB565(brightness, brightness, brightness + 2));
  }
  
  tft.drawRoundRect(containerX, containerY, containerWidth, containerHeight, 12, BORDER_LIGHT);
  tft.drawRoundRect(containerX + 1, containerY + 1, containerWidth - 2, containerHeight - 2, 11, RGB565(220, 230, 235));
  
  tft.setTextSize(1);
  tft.setTextColor(MID_GRAY);
  
  char title[] = "ENTER PASSCODE";
  int16_t x1, y1;
  uint16_t w, h;
  tft.getTextBounds(title, 0, 0, &x1, &y1, &w, &h);
  int titleX = (SCREEN_W - w) / 2;
  tft.setCursor(titleX, containerY + 10);
  tft.print(title);
  
  drawLightPassCircles();
}

// ======================================================
// LIGHT PASSCODE CIRCLES
// ======================================================
void drawLightPassCircles() {
  int circleSpacing = 24;
  int totalWidth = (PASS_LENGTH - 1) * circleSpacing;
  int startX = (SCREEN_W - totalWidth) / 2;
  int circleY = 138;
  int circleRadius = 9;

  for (int i = 0; i < PASS_LENGTH; i++) {
    int circleX = startX + (i * circleSpacing);
    
    if (i < passIndex) {
      for (int g = 0; g < 3; g++) {
        uint16_t glowColor = RGB565(100 + g * 30, 200 + g * 10, 150 + g * 20);
        tft.drawCircle(circleX, circleY, circleRadius + 2 + g, glowColor);
      }
      
      tft.fillCircle(circleX, circleY, circleRadius, SUCCESS_GREEN);
      tft.fillCircle(circleX, circleY, circleRadius - 2, RGB565(100, 220, 150));
      tft.fillCircle(circleX - 3, circleY - 3, 2, RGB565(200, 255, 220));
      
      tft.drawLine(circleX - 3, circleY, circleX - 1, circleY + 2, ST77XX_WHITE);
      tft.drawLine(circleX - 1, circleY + 2, circleX + 3, circleY - 2, ST77XX_WHITE);
      
    } else {
      tft.drawCircle(circleX + 1, circleY + 1, circleRadius, SHADOW_LIGHT);
      tft.drawCircle(circleX, circleY, circleRadius, BORDER_LIGHT);
      tft.drawCircle(circleX, circleY, circleRadius - 1, RGB565(200, 210, 220));
      tft.fillCircle(circleX, circleY, circleRadius - 2, RGB565(252, 252, 254));
      tft.fillCircle(circleX, circleY, 2, RGB565(180, 190, 200));
    }
    
    tft.setTextSize(1);
    tft.setTextColor(SOFT_GRAY);
    tft.setCursor(circleX - 2, circleY + 14);
    tft.print(i + 1);
  }
}

// ======================================================
// QUICK REDRAW CIRCLES
// ======================================================
void quickRedrawCircles() {
  int containerWidth = 110;
  int containerX = (SCREEN_W - containerWidth) / 2;
  tft.fillRect(containerX + 5, 126, containerWidth - 10, 30, RGB565(248, 248, 250));
  drawLightPassCircles();
}

// ======================================================
// BUTTON HANDLER
// ======================================================
void handleButton() {
  bool current = digitalRead(BUTTON_PIN);

  if (current == LOW && lastButton == HIGH) {
    delay(DEBOUNCE);
    lastPressTime = millis();
    
    passIndex++;

    int circleSpacing = 24;
    int totalWidth = (PASS_LENGTH - 1) * circleSpacing;
    int startX = (SCREEN_W - totalWidth) / 2;
    int circleX = startX + ((passIndex - 1) * circleSpacing);
    int circleY = 138;
    
    for (int r = 6; r <= 12; r += 6) {
      tft.drawCircle(circleX, circleY, r, RGB565(100, 220, 150));
      delay(10);
    }
    
    for (int size = 4; size <= 9; size += 3) {
      tft.fillCircle(circleX, circleY, size, SUCCESS_GREEN);
    }
    
    tft.fillCircle(circleX, circleY, 9, SUCCESS_GREEN);
    tft.drawLine(circleX - 3, circleY, circleX - 1, circleY + 2, ST77XX_WHITE);
    tft.drawLine(circleX - 1, circleY + 2, circleX + 3, circleY - 2, ST77XX_WHITE);
    
    if (passIndex >= PASS_LENGTH) {
      currentState = UNLOCKING;
      
      delay(50);  // Reduced from 80ms
      animateSpectacularUnlock();
      fastTransitionToMenu();
      
      drawLightMainMenu();
      currentState = MENU;
    }
  }

  lastButton = current;
}

// ======================================================
// LIGHT THEME MENU WITH OFFSET
// ======================================================
void drawLightMainMenuAtOffset(int xOffset, int yOffset) {
  tft.setTextSize(3);
  tft.setTextColor(DARK_TEXT);
  if (40 + xOffset >= 0 && 40 + xOffset < SCREEN_W) {
    tft.setCursor(40 + xOffset, 15 + yOffset);
    tft.print("MENU");
  }
  
  if (20 + xOffset >= 0 && 38 + yOffset >= 0 && 38 + yOffset < SCREEN_H) {
    int lineStart = max(0, 20 + xOffset);
    int lineEnd = min(SCREEN_W, 108 + xOffset);
    if (lineEnd > lineStart) {
      tft.drawFastHLine(lineStart, 38 + yOffset, lineEnd - lineStart, BORDER_LIGHT);
    }
  }

  tft.setTextSize(2);
  
  if (8 + xOffset >= -112 && 50 + yOffset >= 0 && 50 + yOffset < SCREEN_H) {
    int rectX = max(0, 8 + xOffset);
    int rectW = min(120 + xOffset, SCREEN_W) - rectX;
    if (rectW > 0) {
      tft.fillRoundRect(rectX, 50 + yOffset, rectW, 26, 8, ACCENT_BLUE);
    }
    
    if (20 + xOffset >= 0 && 20 + xOffset < SCREEN_W) {
      tft.setTextColor(ST77XX_WHITE);
      tft.setCursor(20 + xOffset, 56 + yOffset);
      tft.print("Settings");
    }
  }
  
  tft.setTextColor(DARK_TEXT);
  if (20 + xOffset >= 0 && 20 + xOffset < SCREEN_W && 88 + yOffset >= 0 && 88 + yOffset < SCREEN_H) {
    tft.setCursor(20 + xOffset, 88 + yOffset);
    tft.print("Status");
  }
  
  if (20 + xOffset >= 0 && 20 + xOffset < SCREEN_W && 118 + yOffset >= 0 && 118 + yOffset < SCREEN_H) {
    tft.setCursor(20 + xOffset, 118 + yOffset);
    tft.print("About");
  }

  tft.setTextSize(1);
  tft.setTextColor(MID_GRAY);
  if (30 + xOffset >= 0 && 30 + xOffset < SCREEN_W && 148 + yOffset >= 0 && 148 + yOffset < SCREEN_H) {
    tft.setCursor(30 + xOffset, 148 + yOffset);
    tft.print("Tap to select");
  }
}

void drawLightMainMenu() {
  tft.fillScreen(LIGHT_BG);
  drawLightMainMenuAtOffset(0, 0);
}
