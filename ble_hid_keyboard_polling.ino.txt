#include <NimBLEDevice.h>
#include <NimBLEHIDDevice.h>

#define BUTTON_PIN       0       
#define DEBOUNCE_MS      50
#define HID_READY_DELAY  1500    
#define ADV_RESTART_MS   300     

// Globals
NimBLEServer* pServer = nullptr;
NimBLEHIDDevice* hid = nullptr;
NimBLECharacteristic* inputReport = nullptr;
NimBLEAdvertising* pAdvertising = nullptr;

volatile bool button_flag = false;
unsigned long lastDebounce = 0;
unsigned long connectTs = 0;
bool hidReady = false;
int lastConnectedCount = 0;

static const uint8_t keyboardReportDescriptor[] = {
  0x05,0x01,       
  0x09,0x06,        
  0xA1,0x01,     
  0x85,0x01,    
  // Modifiers
  0x05,0x07,0x19,0xE0,0x29,0xE7,
  0x15,0x00,0x25,0x01,0x75,0x01,0x95,0x08,0x81,0x02,
  // Reserved
  0x95,0x01,0x75,0x08,0x81,0x01,
  // Key array (6)
  0x95,0x06,0x75,0x08,0x15,0x00,0x25,0x65,
  0x05,0x07,0x19,0x00,0x29,0x65,0x81,0x00,
  0xC0
};

// HID keyboard report: [Report ID, Modifier, Reserved, Key1-6]
uint8_t keyReport[9] = {0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00};

void IRAM_ATTR onButtonISR() { button_flag = true; }

// Send a HID key (first key slot)
void sendHIDKey(uint8_t hidUsage) {
  int connected = pServer ? pServer->getConnectedCount() : 0;
  Serial.printf("[HID] send request (connected=%d, hidReady=%d)\n", connected, hidReady);

  if (connected == 0) {
    Serial.println("[HID] no connected peer -> skip");
    return;
  }
  if (!hidReady) {
    Serial.println("[HID] HID not ready -> skip");
    return;
  }

  // Press
  memset(keyReport, 0, sizeof(keyReport));
  keyReport[2] = hidUsage; 
  inputReport->setValue(keyReport, sizeof(keyReport));
  inputReport->notify();

  delay(10);

  memset(keyReport, 0, sizeof(keyReport));
  inputReport->setValue(keyReport, sizeof(keyReport));
  inputReport->notify();

  Serial.println("[HID] key sent");
}

void setup() {
  Serial.begin(115200);
  delay(50);
  Serial.println("BLE HID keyboard (bonding simple)");

  pinMode(BUTTON_PIN, INPUT_PULLUP);
  attachInterrupt(digitalPinToInterrupt(BUTTON_PIN), onButtonISR, FALLING);

  NimBLEDevice::init("ESP32-C3");
  NimBLEDevice::setPower(ESP_PWR_LVL_P9);

  NimBLEDevice::setSecurityAuth(true, false, true);

  pServer = NimBLEDevice::createServer();

  hid = new NimBLEHIDDevice(pServer);

  hid->setManufacturer("Maker");
  hid->setPnp(0x02, 0x1234, 0x5678, 0x0101);
  hid->setHidInfo(0x00, 0x01);

  hid->setReportMap((uint8_t*)keyboardReportDescriptor, sizeof(keyboardReportDescriptor));
  inputReport = hid->getInputReport(1);

  hid->startServices();

  // Advertising
  pAdvertising = NimBLEDevice::getAdvertising();
  pAdvertising->addServiceUUID(hid->getHidService()->getUUID());
  pAdvertising->setAppearance(0x03C1); // keyboard
  pAdvertising->start();

  Serial.println("[BLE] Advertising started as 'ESP32-C3'");
  Serial.println("[BLE] Pair the device from OS Bluetooth settings");
}

void loop() {
  int connected = pServer ? pServer->getConnectedCount() : 0;
  static int prevConnected = -1;
  if (connected != prevConnected) {
    Serial.printf("[BLE] connectedCount changed: %d -> %d\n", prevConnected, connected);
    prevConnected = connected;
    if (connected > 0) {
      connectTs = millis();
      hidReady = false;
      if (pAdvertising && pAdvertising->isAdvertising()) {
        pAdvertising->stop();
        Serial.println("[BLE] Advertising stopped (connected).");
      }
    } else {
      Serial.println("[BLE] No peers connected");
    }
  }

  if (connected > 0 && !hidReady && connectTs != 0 && (millis() - connectTs) >= HID_READY_DELAY) {
    hidReady = true;
    Serial.println("[HID] HID ready - will send notifications now");
  }

  static unsigned long lastDiscTs = 0;
  if (connected == 0) {
    if (lastDiscTs == 0) lastDiscTs = millis();
    if ((millis() - lastDiscTs) > ADV_RESTART_MS) {
      if (pAdvertising && !pAdvertising->isAdvertising()) {
        Serial.println("[BLE] Restarting advertising...");
        pAdvertising->start();
      }
      lastDiscTs = 0;
    }
  } else {
    lastDiscTs = 0;
  }

  if (button_flag) {
    unsigned long now = millis();
    if (now - lastDebounce >= DEBOUNCE_MS) {
      lastDebounce = now;
      if (digitalRead(BUTTON_PIN) == LOW) {
        Serial.println("[BUTTON] pressed -> attempt send 'a'");
        sendHIDKey(0x04); //=a
      }
    }
    button_flag = false;
  }

  delay(10);
}
