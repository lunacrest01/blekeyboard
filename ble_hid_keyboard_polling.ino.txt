#include <Adafruit_GFX.h>
#include <Adafruit_ST7735.h>
#include <SPI.h>
#include "image.h"

// ================== CONFIG ==================
#define TFT_CS     10
#define TFT_RST     4
#define TFT_DC      3
#define TFT_SCLK    6
#define TFT_MOSI    7
#define BUTTON_0    0  // Button that enters "0"
#define BUTTON_1    1  // Button that enters "1"

#define SCREEN_W 128
#define SCREEN_H 160
#define PASS_LENGTH 4
#define TIMEOUT_MS 5000
#define DEBOUNCE   60

// Clean Color Palette
#define BG_COLOR 0xEF7D         // Light blue-gray
#define CARD_BG 0xFFFF          // White
#define SHADOW 0xCE79           // Light shadow
#define TEXT_DARK 0x2945        // Dark blue-gray
#define TEXT_LIGHT 0x8C51       // Medium gray
#define ACCENT_BLUE 0x4D7F      // Soft blue
#define ACCENT_PURPLE 0x9A7F    // Purple
#define ACCENT_PINK 0xFBDA      // Pink
#define ACCENT_ORANGE 0xFC60    // Orange
#define SUCCESS_GREEN 0x07E0    // Green
#define ERROR_RED 0xF800        // Red
#define CIRCLE_EMPTY 0xD69A     // Light gray

Adafruit_ST7735 tft(TFT_CS, TFT_DC, TFT_MOSI, TFT_SCLK, TFT_RST);

// ================== STATE ==================
enum State { BOOTING, LOCKED, UNLOCKING, MENU };
State currentState = BOOTING;

// ================== PASSCODE ==================
// CHANGE THIS TO SET YOUR PASSCODE
// Example: {0,0,1,1} means press Button0, Button0, Button1, Button1
const uint8_t CORRECT_PASSCODE[PASS_LENGTH] = {0, 0, 0, 0};
uint8_t enteredPasscode[PASS_LENGTH] = {0, 0, 0, 0};

uint8_t passIndex = 0;
unsigned long lastPressTime = 0;
bool lastButton0 = HIGH;
bool lastButton1 = HIGH;
uint8_t selectedMenuItem = 0;

// ======================================================
// FUNCTION DECLARATIONS
// ======================================================
void drawLockScreen();
void drawLockIcon(int x, int y, bool unlocked);
void drawPasscodeCircles();
void showUnlockAnimation();
void showLockedAnimation();
void drawMenu();
void drawLoveLetter(int x, int y);
void drawLandscape(int x, int y);
void drawNote(int x, int y);
void drawProfile(int x, int y);
void drawParty(int x, int y);
uint16_t RGB(uint8_t r, uint8_t g, uint8_t b);
bool checkPasscode();
void handleButtons();

// ======================================================
// PASSCODE CHECK
// ======================================================
bool checkPasscode() {
  for (int i = 0; i < PASS_LENGTH; i++) {
    if (enteredPasscode[i] != CORRECT_PASSCODE[i]) {
      return false;
    }
  }
  return true;
}

// ======================================================
// SETUP
// ======================================================
void setup() {
  SPI.begin();
  SPI.setFrequency(80000000);
  pinMode(BUTTON_0, INPUT_PULLUP);
  pinMode(BUTTON_1, INPUT_PULLUP);

  tft.initR(INITR_BLACKTAB);
  tft.setRotation(0);

  showBootLogo();
  delay(800);

  drawLockScreen(); 
  currentState = LOCKED;
}

// ======================================================
// MAIN LOOP
// ======================================================
void loop() {
  handleButtons();

  if (currentState == LOCKED && millis() - lastPressTime > TIMEOUT_MS && passIndex > 0) {
    passIndex = 0;
    // Clear entered passcode
    for (int i = 0; i < PASS_LENGTH; i++) {
      enteredPasscode[i] = 0;
    }
    drawPasscodeCircles();
  }
}

// ======================================================
// BOOT LOGO
// ======================================================
void showBootLogo() {
  tft.startWrite();
  tft.setAddrWindow(0, 0, SCREEN_W, SCREEN_H);
  for (int i = 0; i < SCREEN_W * SCREEN_H; i++) {
    tft.pushColor(unnamed_1_1_[i]);
  }
  tft.endWrite();
}

// ======================================================
// RGB565 HELPER
// ======================================================
uint16_t RGB(uint8_t r, uint8_t g, uint8_t b) {
  return ((r & 0xF8) << 8) | ((g & 0xFC) << 3) | (b >> 3);
}

// ======================================================
// LOCK SCREEN
// ======================================================
void drawLockScreen() {
  // Clean gradient background
  for (int y = 0; y < SCREEN_H; y++) {
    uint8_t shade = 235 - (y / 15);
    tft.drawFastHLine(0, y, SCREEN_W, RGB(shade, shade + 5, shade + 10));
  }

  // Main card
  int cardY = 30;
  int cardH = 85;
  
  // Shadow
  tft.fillRoundRect(12, cardY + 2, 104, cardH, 15, SHADOW);
  
  // White card
  tft.fillRoundRect(10, cardY, 104, cardH, 15, CARD_BG);
  tft.drawRoundRect(10, cardY, 104, cardH, 15, ACCENT_BLUE);
  
  // Lock icon
  drawLockIcon(64, 65, false);
  
  // "LOCKED" text
  tft.setTextSize(1);
  tft.setTextColor(TEXT_DARK);
  tft.setCursor(46, 95);
  tft.print("LOCKED");
  
  // "Enter Passcode" label
  tft.setTextColor(TEXT_LIGHT);
  tft.setCursor(23, 118);
  tft.print("Enter Passcode");
  
  // Passcode circles
  drawPasscodeCircles();
}

// ======================================================
// LOCK ICON
// ======================================================
void drawLockIcon(int x, int y, bool unlocked) {
  if (unlocked) {
    // Unlocked - green with open shackle
    // Body
    tft.fillRoundRect(x - 10, y - 2, 20, 24, 4, RGB(230, 255, 230));
    tft.drawRoundRect(x - 10, y - 2, 20, 24, 4, SUCCESS_GREEN);
    tft.drawRoundRect(x - 9, y - 1, 18, 22, 3, SUCCESS_GREEN);
    
    // Keyhole
    tft.fillCircle(x, y + 8, 3, SUCCESS_GREEN);
    tft.fillRect(x - 1, y + 10, 2, 6, SUCCESS_GREEN);
    
    // Open shackle (lifted up and to the left)
    int shackleY = y - 24;
    tft.drawCircle(x, shackleY, 10, SUCCESS_GREEN);
    tft.drawCircle(x, shackleY, 9, SUCCESS_GREEN);
    tft.drawFastVLine(x - 10, shackleY, 8, SUCCESS_GREEN);
    tft.drawFastVLine(x - 9, shackleY, 8, SUCCESS_GREEN);
    
  } else {
    // Locked - blue with closed shackle
    // Body
    tft.fillRoundRect(x - 10, y - 2, 20, 24, 4, RGB(240, 245, 255));
    tft.drawRoundRect(x - 10, y - 2, 20, 24, 4, ACCENT_BLUE);
    tft.drawRoundRect(x - 9, y - 1, 18, 22, 3, ACCENT_BLUE);
    
    // Keyhole
    tft.fillCircle(x, y + 8, 3, ACCENT_BLUE);
    tft.fillRect(x - 1, y + 10, 2, 6, ACCENT_BLUE);
    tft.drawPixel(x - 1, y + 7, RGB(200, 220, 255));
    
    // Closed shackle
    tft.drawCircle(x, y - 12, 10, ACCENT_BLUE);
    tft.drawCircle(x, y - 12, 9, ACCENT_BLUE);
    tft.drawCircle(x, y - 12, 8, ACCENT_BLUE);
    
    // Shackle sides
    tft.drawFastVLine(x - 10, y - 12, 10, ACCENT_BLUE);
    tft.drawFastVLine(x - 9, y - 12, 10, ACCENT_BLUE);
    tft.drawFastVLine(x - 8, y - 12, 10, ACCENT_BLUE);
    tft.drawFastVLine(x + 8, y - 12, 10, ACCENT_BLUE);
    tft.drawFastVLine(x + 9, y - 12, 10, ACCENT_BLUE);
    tft.drawFastVLine(x + 10, y - 12, 10, ACCENT_BLUE);
  }
}

// ======================================================
// PASSCODE CIRCLES
// ======================================================
void drawPasscodeCircles() {
  int spacing = 24;
  int startX = (SCREEN_W - (PASS_LENGTH - 1) * spacing) / 2;
  int circleY = 138;
  
  // Clear area with gradient background
  for (int y = 133; y < 151; y++) {
    uint8_t shade = 235 - (y / 15);
    tft.drawFastHLine(15, y, 98, RGB(shade, shade + 5, shade + 10));
  }

  for (int i = 0; i < PASS_LENGTH; i++) {
    int x = startX + (i * spacing);
    
    if (i < passIndex) {
      // Filled - show different colors for 0 vs 1
      uint16_t fillColor;
      if (enteredPasscode[i] == 0) {
        fillColor = ACCENT_BLUE;  // Blue for "0"
      } else {
        fillColor = ACCENT_PURPLE;  // Purple for "1"
      }
      
      tft.fillCircle(x, circleY, 7, fillColor);
      tft.drawCircle(x, circleY, 7, fillColor);
      
      // Show the digit
      tft.setTextSize(1);
      tft.setTextColor(CARD_BG);
      tft.setCursor(x - 3, circleY - 4);
      tft.print(enteredPasscode[i]);
      
    } else {
      // Empty - just outline
      tft.drawCircle(x, circleY, 7, CIRCLE_EMPTY);
      tft.drawCircle(x, circleY, 6, CIRCLE_EMPTY);
      tft.fillCircle(x, circleY, 2, CIRCLE_EMPTY);
    }
  }
}

// ======================================================
// UNLOCK ANIMATION - Blinks 2 times
// ======================================================
void showUnlockAnimation() {
  // "UNLOCKED" text blinks 2 times with glow effect
  for (int blink = 0; blink < 2; blink++) {
    // Clear text region
    tft.fillRect(10, 60, 108, 35, BG_COLOR);
    
    delay(30);
    
    // Redraw background gradient
    for (int y = 60; y < 95; y++) {
      uint8_t shade = 235 - (y / 15);
      tft.drawFastHLine(10, y, 108, RGB(shade, shade + 5, shade + 10));
    }
    
    delay(20);
    
    // Draw glow effect
    tft.setTextSize(2);
    tft.setTextColor(RGB(180, 255, 180));
    tft.setCursor(21, 69);
    tft.print("UNLOCKED");
    tft.setCursor(23, 71);
    tft.print("UNLOCKED");
    
    // Main text - bright green
    tft.setTextColor(SUCCESS_GREEN);
    tft.setCursor(22, 70);
    tft.print("UNLOCKED");
    
    delay(350);
    
    // Clear again
    tft.fillRect(10, 60, 108, 35, BG_COLOR);
    
    // Redraw gradient
    for (int y = 60; y < 95; y++) {
      uint8_t shade = 235 - (y / 15);
      tft.drawFastHLine(10, y, 108, RGB(shade, shade + 5, shade + 10));
    }
    
    delay(250);
  }
  
  // Final display - stays visible
  tft.fillRect(10, 60, 108, 35, BG_COLOR);
  for (int y = 60; y < 95; y++) {
    uint8_t shade = 235 - (y / 15);
    tft.drawFastHLine(10, y, 108, RGB(shade, shade + 5, shade + 10));
  }
  
  delay(20);
  
  tft.setTextSize(2);
  tft.setTextColor(RGB(180, 255, 180));
  tft.setCursor(21, 69);
  tft.print("UNLOCKED");
  tft.setCursor(23, 71);
  tft.print("UNLOCKED");
  
  tft.setTextColor(SUCCESS_GREEN);
  tft.setCursor(22, 70);
  tft.print("UNLOCKED");
  
  delay(400);
}

// ======================================================
// LOCKED ANIMATION - Blinks 2 times (for wrong password)
// ======================================================
void showLockedAnimation() {
  // "LOCKED" text blinks 2 times with red glow
  for (int blink = 0; blink < 2; blink++) {
    // Clear text region
    tft.fillRect(10, 60, 108, 35, BG_COLOR);
    
    delay(30);
    
    // Redraw background gradient
    for (int y = 60; y < 95; y++) {
      uint8_t shade = 235 - (y / 15);
      tft.drawFastHLine(10, y, 108, RGB(shade, shade + 5, shade + 10));
    }
    
    delay(20);
    
    // Draw glow effect - red
    tft.setTextSize(2);
    tft.setTextColor(RGB(255, 180, 180));
    tft.setCursor(27, 69);
    tft.print("LOCKED");
    tft.setCursor(29, 71);
    tft.print("LOCKED");
    
    // Main text - bright red
    tft.setTextColor(ERROR_RED);
    tft.setCursor(28, 70);
    tft.print("LOCKED");
    
    delay(350);
    
    // Clear again
    tft.fillRect(10, 60, 108, 35, BG_COLOR);
    
    // Redraw gradient
    for (int y = 60; y < 95; y++) {
      uint8_t shade = 235 - (y / 15);
      tft.drawFastHLine(10, y, 108, RGB(shade, shade + 5, shade + 10));
    }
    
    delay(250);
  }
  
  // RESET passcode data BEFORE redrawing
  passIndex = 0;
  for (int i = 0; i < PASS_LENGTH; i++) {
    enteredPasscode[i] = 0;
  }
  
  // Now redraw lock screen with empty circles
  drawLockScreen();
}

// ======================================================
// MENU
// ======================================================
void drawMenu() {
  // Gradient background with subtle variation
  for (int y = 0; y < SCREEN_H; y++) {
    uint8_t shade = 245 - (y / 12);
    tft.drawFastHLine(0, y, SCREEN_W, RGB(shade - 5, shade, shade + 8));
  }
  
  // Title card with enhanced styling
  int titleY = 10;
  
  // Shadow layer
  tft.fillRoundRect(24, titleY + 3, 80, 30, 14, RGB(180, 185, 195));
  
  // Main card
  tft.fillRoundRect(23, titleY, 80, 30, 14, CARD_BG);
  
  // Gradient border effect
  for (int i = 0; i < 3; i++) {
    tft.drawRoundRect(23 + i, titleY + i, 80 - (i*2), 30 - (i*2), 14 - i, ACCENT_PURPLE);
  }
  
  // Title text with shadow
  tft.setTextSize(2);
  tft.setTextColor(RGB(200, 190, 220));
  tft.setCursor(42, 18);
  tft.print("MENU");
  
  tft.setTextColor(TEXT_DARK);
  tft.setCursor(41, 17);
  tft.print("MENU");
  
  // Modern divider with decorative dots
  tft.fillCircle(15, 50, 2, ACCENT_PURPLE);
  tft.fillCircle(113, 50, 2, ACCENT_PURPLE);
  for (int i = 0; i < 2; i++) {
    tft.drawFastHLine(20, 50 + i, 88, RGB(210, 215, 225));
  }
  
  // Menu items with improved design
  const char* items[] = {"Hope Letter", "Memories", "Quote", "About"};
  uint16_t colors[] = {ACCENT_PURPLE, ACCENT_PINK, ACCENT_BLUE, ACCENT_ORANGE};
  
  int startY = 62;
  int itemHeight = 23;
  int spacing = 4;
  
  for (int i = 0; i < 4; i++) {
    int y = startY + (i * (itemHeight + spacing));
    
    // Layered shadow for depth
    tft.fillRoundRect(13, y + 3, 102, itemHeight, 11, RGB(190, 195, 205));
    tft.fillRoundRect(12, y + 2, 102, itemHeight, 11, SHADOW);
    
    // Main card with gradient border
    tft.fillRoundRect(11, y, 102, itemHeight, 11, CARD_BG);
    
    for (int b = 0; b < 2; b++) {
      tft.drawRoundRect(11 + b, y + b, 102 - (b*2), itemHeight - (b*2), 11 - b, colors[i]);
    }
    
    // Number badge with enhanced styling
    int badgeX = 21;
    int badgeY = y + 11;
    
    // Badge shadow
    tft.fillCircle(badgeX + 1, badgeY + 1, 8, RGB(180, 185, 195));
    
    // Badge with gradient effect
    tft.fillCircle(badgeX, badgeY, 9, colors[i]);
    tft.fillCircle(badgeX, badgeY, 8, colors[i]);
    
    // Number text
    tft.setTextSize(1);
    tft.setTextColor(CARD_BG);
    tft.setCursor(badgeX - 3, badgeY - 4);
    tft.print(i + 1);
    
    // Emoji with subtle background
    int emojiX = 37;
    int emojiY = y + 6;
    
    // Emoji background circle
    tft.fillCircle(emojiX + 5, emojiY + 5, 9, RGB(248, 250, 252));
    tft.drawCircle(emojiX + 5, emojiY + 5, 9, RGB(230, 235, 240));
    
    switch(i) {
      case 0: drawLoveLetter(emojiX, emojiY); break;
      case 1: drawLandscape(emojiX, emojiY); break;
      case 2: drawNote(emojiX, emojiY); break;
      case 3: drawProfile(emojiX, emojiY); break;
    }
    
    // Text with shadow effect
    tft.setTextColor(RGB(200, 205, 215));
    tft.setCursor(55, y + 8);
    tft.print(items[i]);
    
    tft.setTextColor(TEXT_DARK);
    tft.setCursor(54, y + 7);
    tft.print(items[i]);
  }
  
  // Bottom info bar with icon
  tft.fillRoundRect(18, 148, 92, 9, 4, RGB(230, 235, 245));
  tft.setTextSize(1);
  tft.setTextColor(TEXT_LIGHT);
  tft.setCursor(25, 149);
  tft.print("Press to cycle");
  
  // Decorative arrow
  tft.fillTriangle(103, 150, 103, 154, 106, 152, ACCENT_BLUE);
}

// ======================================================
// BUTTON HANDLER - BOTH BUTTONS REGISTER DIGITS
// ======================================================
void handleButtons() {
  bool currentButton0 = digitalRead(BUTTON_0);
  bool currentButton1 = digitalRead(BUTTON_1);

  // Handle Button 0 press (enters "0")
  if (currentButton0 == LOW && lastButton0 == HIGH) {
    delay(DEBOUNCE);
    lastPressTime = millis();
    
    if (currentState == LOCKED && passIndex < PASS_LENGTH) {
      // Record "0"
      enteredPasscode[passIndex] = 0;
      passIndex++;
      
      // Visual feedback
      int spacing = 24;
      int startX = (SCREEN_W - (PASS_LENGTH - 1) * spacing) / 2;
      int x = startX + ((passIndex - 1) * spacing);
      int y = 138;
      
      for (int r = 7; r < 11; r += 2) {
        tft.drawCircle(x, y, r, ACCENT_BLUE);
        delay(12);
      }
      
      drawPasscodeCircles();
      
      // Check if all 4 digits entered
      if (passIndex >= PASS_LENGTH) {
        delay(200);
        
        if (checkPasscode()) {
          // Correct!
          currentState = UNLOCKING;
          showUnlockAnimation();
          drawMenu();
          currentState = MENU;
        } else {
          // Wrong!
          showLockedAnimation();
        }
      }
      
    } else if (currentState == MENU) {
      selectedMenuItem = (selectedMenuItem + 1) % 4;
    }
  }

  // Handle Button 1 press (enters "1")
  if (currentButton1 == LOW && lastButton1 == HIGH) {
    delay(DEBOUNCE);
    lastPressTime = millis();
    
    if (currentState == LOCKED && passIndex < PASS_LENGTH) {
      // Record "1"
      enteredPasscode[passIndex] = 1;
      passIndex++;
      
      // Visual feedback
      int spacing = 24;
      int startX = (SCREEN_W - (PASS_LENGTH - 1) * spacing) / 2;
      int x = startX + ((passIndex - 1) * spacing);
      int y = 138;
      
      for (int r = 7; r < 11; r += 2) {
        tft.drawCircle(x, y, r, ACCENT_PURPLE);
        delay(12);
      }
      
      drawPasscodeCircles();
      
      // Check if all 4 digits entered
      if (passIndex >= PASS_LENGTH) {
        delay(200);
        
        if (checkPasscode()) {
          // Correct!
          currentState = UNLOCKING;
          showUnlockAnimation();
          drawMenu();
          currentState = MENU;
        } else {
          // Wrong!
          showLockedAnimation();
        }
      }
      
    } else if (currentState == MENU) {
      // Can also use button 1 in menu if you want
      selectedMenuItem = (selectedMenuItem + 1) % 4;
    }
  }

  lastButton0 = currentButton0;
  lastButton1 = currentButton1;
}

// ======================================================
// EMOJI DRAWINGS
// ======================================================

// Love Letter üíå
void drawLoveLetter(int x, int y) {
  tft.fillRect(x, y + 2, 10, 7, RGB(255, 240, 245));
  tft.drawRect(x, y + 2, 10, 7, RGB(255, 150, 180));
  tft.fillTriangle(x, y + 2, x + 10, y + 2, x + 5, y - 1, RGB(255, 200, 220));
  tft.drawLine(x, y + 2, x + 5, y - 1, RGB(255, 150, 180));
  tft.drawLine(x + 10, y + 2, x + 5, y - 1, RGB(255, 150, 180));
  tft.fillCircle(x + 3, y + 5, 1, RGB(255, 100, 140));
  tft.fillCircle(x + 5, y + 5, 1, RGB(255, 100, 140));
  tft.fillTriangle(x + 2, y + 5, x + 6, y + 5, x + 4, y + 7, RGB(255, 100, 140));
}

// Landscape üèûÔ∏è
void drawLandscape(int x, int y) {
  tft.fillRect(x, y, 10, 4, RGB(135, 206, 250));
  tft.fillTriangle(x, y + 4, x + 5, y, x + 10, y + 4, RGB(139, 137, 137));
  tft.fillCircle(x + 8, y + 1, 2, RGB(255, 223, 0));
  tft.fillRect(x, y + 4, 10, 4, RGB(144, 238, 144));
}

// Note/Memo üìù
void drawNote(int x, int y) {
  tft.fillRect(x + 1, y, 8, 10, RGB(255, 255, 240));
  tft.drawRect(x + 1, y, 8, 10, RGB(200, 200, 180));
  tft.drawFastHLine(x + 2, y + 2, 5, RGB(100, 150, 255));
  tft.drawFastHLine(x + 2, y + 4, 5, RGB(100, 150, 255));
  tft.drawFastHLine(x + 2, y + 6, 5, RGB(100, 150, 255));
  tft.drawFastHLine(x + 2, y + 8, 3, RGB(100, 150, 255));
}

// Profile/Person üë§
void drawProfile(int x, int y) {
  tft.fillCircle(x + 5, y + 2, 3, RGB(100, 120, 140));
  tft.fillCircle(x + 5, y + 8, 4, RGB(100, 120, 140));
  tft.fillRect(x + 1, y + 8, 8, 2, RGB(240, 245, 255));
}

// Party Popper üéâ
void drawParty(int x, int y) {
  tft.fillTriangle(x + 5, y, x + 1, y + 10, x + 9, y + 10, RGB(255, 200, 100));
  tft.drawTriangle(x + 5, y, x + 1, y + 10, x + 9, y + 10, RGB(220, 160, 80));
  tft.fillRect(x - 1, y - 2, 2, 2, RGB(255, 100, 150));
  tft.fillRect(x + 11, y - 1, 2, 2, RGB(100, 200, 255));
  tft.fillRect(x + 3, y - 4, 2, 2, RGB(150, 255, 100));
  tft.fillRect(x + 9, y - 3, 2, 2, RGB(255, 255, 100));
  tft.drawPixel(x, y + 2, RGB(255, 150, 200));
  tft.drawPixel(x + 12, y + 1, RGB(200, 150, 255));
}
